<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="../assets/css/style.css" rel="stylesheet">
    <link href="../node_modules/lightbox2/src/css/lightbox.css" rel="stylesheet" />

    <script src="../node_modules/pizzip/dist/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="../assets/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/img/favicon-16x16.png">
    <link rel="manifest" href="../assets/site.webmanifest">

    <!--REPLACE WITH https://files.revvnik.com/-->
    <title>Revvnik - Files</title>
</head>

<body>

    <div class="container header">
        <p id="headerText">Download your photos!</p>
        <img id="headerImage" src="../assets/camera.png">
    </div>

    <div class="container hint" id="hintContainer">
        <p id="hintText">
            By clicking on the below button, you will receive a popup prompting for the decryption key. This is a
            security measure. <br> Please wait until all the images have loaded.
        </p>

        <div class="hintButtons">
            <button class="startDecryption" id="startDecryption" onclick="promptForKey();">&nbsp;&nbsp;Enter
                key&nbsp;&nbsp;</button>
        </div>
    </div>

    <div class="space1"></div>

    <div id="image-grid" class="image-grid">
        <!-- Decrypted images will appear here -->
    </div>

    <div class="container space1"></div>
    <div class="container space1" style="height: 0.3vh;"></div>

    <div class="wrapper" id="wrapper">
        <div class="footer" id="footer">
            <div class="paypal" style="display: flex; flex-direction: row;">
                <!--<p style="margin: 0;">IF YOU LIKE MY WORK, YOU CAN SUPPORT ME ON&nbsp;&nbsp;</p>-->

            </div>

            <p style="margin: 0;">FOR CONTACT,&nbsp;&nbsp;PLEASE EMAIL ME AT&nbsp;&nbsp;</p>
            <p style="opacity: 100%;">
                <a href="mailto:revvnik@gmail.com" style="text-decoration: none;">revvnik@gmail.com</a><br>
            </p>
            <p>
                <a href="https://paypal.me/nik.sttr" style="text-decoration: none;">
                    SUPPORT ME <i class="bi bi-paypal"></i> nik.sttr
                </a>
            </p>
            <p>REVVNIK © 2021-2025 ALL RIGHTS RESERVED</p>
        </div>
    </div>
    <script>
        let zipping;

        async function promptForKey() {
            const hexKey = prompt('Please enter the decryption key:');
            const key = hexToBytes(hexKey);
            if (key.length !== 16 && key.length !== 24 && key.length !== 32) {
                alert('Key length must be 16, 24, or 32 characters.');
                return;
            }
            if (hexKey) {
                const { albumName, albumFiles, watermarkedFiles, instagramSizedFiles } = await loadEncryptedFiles();
                decryptAndDisplayImages(albumFiles, hexKey, albumName, watermarkedFiles, instagramSizedFiles);
            } else {
                alert("No key provided.");
            }
        }

        async function loadEncryptedFiles() {
            try {
                const response = await fetch('images.json');
                if (!response.ok) {
                    throw new Error('Failed to load JSON file');
                }
                const data = await response.json();

                return {
                    albumName: data.name,
                    albumFiles: data.noWatermarkFiles,
                    watermarkedFiles: data.watermarkedFiles,
                    instagramSizedFiles: data.instagramSizedFiles
                };
            } catch (error) {
                alert(`Error loading files: ${error.message}`);
                return [];
            }
        }

        async function decryptAndDisplayImages(files, key, albumName, watermarkedFiles, instagramSizedFiles) {
            zipping = true;
            const imageGrid = document.getElementById('image-grid');
            imageGrid.innerHTML = '';

            const startDecryptionButton = document.querySelector('.startDecryption');
            startDecryptionButton.disabled = true;

            const totalImages = files.length + watermarkedFiles.length + instagramSizedFiles.length;
            let loadedImages = 0;

            function updateHintText() {
                // document.getElementById('hintText').innerHTML = `Images Loaded: ${loadedImages}/${totalImages}`;
                $('#imageLoadedText').replaceWith(`<p id="imageLoadedText">Images Loaded: ${loadedImages}/${totalImages}</p>`)
            }

            document.getElementById("wrapper").remove();
            $('#startDecryption').replaceWith('<button class="startDecryption" id="startDecryption" disabled>&nbsp;&nbsp;Please Wait...&nbsp;&nbsp;</button></div>')
            $('#hintText').replaceWith('<p id="hintText"> Please wait while we prepare your file. Please also note that the file size may be bigger than expected, due to the file size of the images. Do not leave the page.</p>');
            $(`<p id="imageLoadedText">Images Loaded: ${loadedImages}/${totalImages}</p>`).appendTo('#hintText')
            $('#headerImage').hide();
            $('<div class="spinner-border text-light" id="spinner" role="status"><span class="sr-only"></span><br></div>').appendTo('#hintText')
            $('#headerText').replaceWith(`${albumName}`);
            window.document.title = albumName;
            $('<div class="wrapper" id="wrapper"><div class="footer" id="footer"><p style="margin: 0;">FOR CONTACT,&nbsp;&nbsp;PLEASE EMAIL ME AT&nbsp;&nbsp;</p><p style="opacity: 100%;"><a href="mailto:revvnik@gmail.com"style="text-decoration: none;">&nbsp;revvnik@gmail.com</a><br></p><p><a href="https://paypal.me/nik.sttr" style="text-decoration: none;">SUPPORT ME <i class="bi bi-paypal"></i> nik.sttr</a></p><p>REVVNIK © 2021-2025 ALL RIGHTS RESERVED</p></div></div>').appendTo($('body'));




            const decryptPromises = files.map((file, index) => decryptFile(`encrypted/${file}`, key).then(url => {
                loadedImages++;
                updateHintText();
                return { index, url, fileName: file };
            }));

            const decryptWatermarkPromises = watermarkedFiles.map((file, index) => decryptFile(`encrypted-watermarked/${file}`, key).then(url => {
                loadedImages++;
                updateHintText();
                return { index, url, fileName: file };
            }));

            const decryptResizedPromises = instagramSizedFiles.map((file, index) => decryptFile(`encrypted-resized/${file}`, key).then(url => {
                loadedImages++;
                updateHintText();
                return { index, url, fileName: file };
            }));


            const decryptedImages = (await Promise.all(decryptPromises)).filter(image => image.url);
            const decryptedWatermarkedImages = (await Promise.all(decryptWatermarkPromises)).filter(image => image.url);
            const decryptedResizedImages = (await Promise.all(decryptResizedPromises)).filter(image => image.url);

            decryptedImages.sort((a, b) => a.index - b.index).forEach(({ url }) => {
                const anchor = document.createElement('a');
                anchor.href = url;
                anchor.setAttribute('data-lightbox', 'gallery');

                const img = document.createElement('img');
                img.src = url;
                img.alt = 'Decrypted Image';
                anchor.appendChild(img);

                imageGrid.appendChild(anchor);
            });

            decryptedWatermarkedImages.sort((a, b) => a.index - b.index).forEach(({ url }) => {
                const anchor = document.createElement('a');
                anchor.href = url;
                anchor.setAttribute('data-lightbox', 'gallery');

                const img = document.createElement('img');
                img.src = url;
                img.alt = 'Decrypted Image';
                anchor.appendChild(img);

                imageGrid.appendChild(anchor);
            });

            decryptedResizedImages.sort((a, b) => a.index - b.index).forEach(({ url }) => {
                const anchor = document.createElement('a');
                anchor.href = url;
                anchor.setAttribute('data-lightbox', 'gallery');

                const img = document.createElement('img');
                img.src = url;
                img.alt = 'Decrypted Image';
                anchor.appendChild(img);

                imageGrid.appendChild(anchor);
            });

            // Generate ZIP
            var zip = new PizZip();
            const folder = zip.folder(albumName);
            const watermarkedFolder = zip.folder("Watermarked");
            const resizedFolder = zip.folder("Resized");



            // Add files to ZIP using async approach
            const filePromises = decryptedImages.map(async ({ fileName, url }) => {
                const response = await fetch(url);
                const blob = await response.blob(); // Get the image as a Blob
                const arrayBuffer = await blob.arrayBuffer(); // Convert Blob to ArrayBuffer
                folder.file(fileName, arrayBuffer); // Add the ArrayBuffer directly to the ZIP
            });

            const watermarkedFilePromises = decryptedWatermarkedImages.map(async ({ fileName, url }) => {
                const response = await fetch(url);
                const blob = await response.blob(); // Get the image as a Blob
                const arrayBuffer = await blob.arrayBuffer(); // Convert Blob to ArrayBuffer
                watermarkedFolder.file(fileName, arrayBuffer); // Add the ArrayBuffer directly to the ZIP
            });

            const resizedFilePromises = decryptedResizedImages.map(async ({ fileName, url }) => {
                const response = await fetch(url);
                const blob = await response.blob(); // Get the image as a Blob
                const arrayBuffer = await blob.arrayBuffer(); // Convert Blob to ArrayBuffer
                resizedFolder.file(fileName, arrayBuffer); // Add the ArrayBuffer directly to the ZIP
            });

            // Wait for all files to be added before generating the ZIP
            await Promise.all(filePromises, watermarkedFilePromises, resizedFilePromises);


            // Generate the ZIP file
            const zipBlob = await zip.generate({ type: 'blob' });
            const zipUrl = URL.createObjectURL(zipBlob);
            const zipSize = zipBlob.size;
            const zipSizeKB = (zipSize / 1024).toFixed(2); // Size in KB
            const zipSizeMB = (zipSize / (1024 * 1024)).toFixed(2); // Size in MB

            $('#spinner').hide();
            $('#startDecryption').replaceWith(`
                <a id="downloadAllButton" 
                    class="downloadAllButton btn btn-primary"
                    href="${zipUrl}" 
                    download="${albumName.charAt(0).toUpperCase() + albumName.slice(1)}.zip" 
                    style="background-color: #477DAC;">
                    Download ${decryptedImages.length + decryptedWatermarkedImages.length + decryptedResizedImages.length} total files (${zipSizeMB}MB)
                </a>
            `);


        }

        async function decryptFile(filePath, hexKey) {
            const key = hexToBytes(hexKey);
            const iv = new Uint8Array(16);

            const extension = filePath.slice(filePath.lastIndexOf('.')).toLowerCase();
            const mimeType = {
                '.jpg': 'image/jpeg',
                '.jpeg': 'image/jpeg',
                '.png': 'image/png',
                '.gif': 'image/gif',
                '.webp': 'image/webp'
            }[extension] || 'application/octet-stream';

            try {
                const response = await fetch(filePath);
                const buffer = await response.arrayBuffer();
                const cryptoKey = await crypto.subtle.importKey('raw', key, { name: 'AES-CBC' }, false, ['decrypt']);
                const decryptedData = await crypto.subtle.decrypt({ name: 'AES-CBC', iv }, cryptoKey, buffer);

                const blob = new Blob([decryptedData], { type: mimeType });
                return URL.createObjectURL(blob);
            } catch (error) {
                console.error(`Error decrypting file ${filePath}:`, error);
                return null;
            }
        }

        function hexToBytes(hex) {
            const bytes = [];
            for (let i = 0; i < hex.length; i += 2) {
                bytes.push(parseInt(hex.substr(i, 2), 16));
            }
            return new Uint8Array(bytes);
        }
    </script>


    <script src="../node_modules/lightbox2/src/js/lightbox.js"></script>
</body>

</html>