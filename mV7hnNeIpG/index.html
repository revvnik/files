<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
            integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://files.revvnik.com/assets/css/style.css" rel="stylesheet"> <!--REPLACE WITH https://files.revvnik.com/assets/css/style.css-->
    <title>Revvnik - Files</title>
</head>

<body>

    <div class="container header">
        <p>Download your photos!</p>
        <img src="https://files.revvnik.com/assets/css/style.css/camera.png">
    </div>

    <div class="container hint">
        <p>
            By clicking on the below button, you will receive a popup prompting for the decryption key. This is a
            security measure.
        </p>
        <button class="startDecryption" onclick="promptForKey();">Enter key</button>
    </div>

    <div class="space1"></div>

    <div id="image-grid" class="image-grid">
        <!-- Decrypted images will appear here -->
    </div>

    <script>
        async function promptForKey() {
            const hexKey = prompt('Please enter the decryption key (hex):');
            if (hexKey) {
                const encryptedFiles = await loadEncryptedFiles();
                decryptAndDisplayImages(encryptedFiles, hexKey);
            }
        }

        async function loadEncryptedFiles() {
            try {
                const response = await fetch('images.json');
                if (!response.ok) {
                    throw new Error('Failed to load JSON file');
                }
                const data = await response.json();
                return data.files;
            } catch (error) {
                alert(`Error loading files: ${error.message}`);
                return [];
            }
        }

        async function decryptAndDisplayImages(files, key) {
            const imageGrid = document.getElementById('image-grid');
            imageGrid.innerHTML = '';  // Clear any existing images

            for (let i = 0; i < files.length; i++) {
                const filePath = `encrypted/${files[i]}`;
                try {
                    const decryptedImageUrl = await decryptFile(filePath, key);
                    const imgElement = document.createElement('img');
                    imgElement.src = decryptedImageUrl;
                    imgElement.alt = `Decrypted Image ${i + 1}`;
                    imageGrid.appendChild(imgElement);
                } catch (error) {
                    alert(`Failed to decrypt ${files[i]}: ${error.message}`);
                }
            }
        }

        async function decryptFile(filePath, hexKey) {
            const key = hexToBytes(hexKey);
            const iv = new Uint8Array(16); // Default IV of zeros

            // Validate key length
            if (key.length !== 16 && key.length !== 24 && key.length !== 32) {
                alert('Key length must be 16, 24, or 32 bytes.');
                return;
            }

            // Import key
            const cryptoKey = await crypto.subtle.importKey(
                'raw',
                key,
                { name: 'AES-CBC' },
                false,
                ['decrypt']
            );

            // Fetch the file as an ArrayBuffer
            const fileResponse = await fetch(filePath);
            const fileArrayBuffer = await fileResponse.arrayBuffer();

            try {
                // Decrypt file
                const decryptedData = await crypto.subtle.decrypt(
                    { name: 'AES-CBC', iv: iv },
                    cryptoKey,
                    fileArrayBuffer
                );

                const mimeType = 'image/jpeg';  // Assume image type (or derive based on filename)
                const decryptedBlob = new Blob([decryptedData], { type: mimeType });
                const url = URL.createObjectURL(decryptedBlob);

                // Return image URL
                return url;
            } catch (error) {
                alert('Decryption failed: ' + error.message);
                throw error;
            }
        }

        function hexToBytes(hex) {
            let bytes = [];
            for (let i = 0; i < hex.length; i += 2) {
                bytes.push(parseInt(hex.substring(i, i + 2), 16));
            }
            return new Uint8Array(bytes);
        }
    </script>

</body>
</html>